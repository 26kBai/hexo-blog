---
title:  文献阅读-Delivery Scope-A New Way of Restaurant Retrieval For On-demand Food Delivery Service
tags:
  - 机器学习
  - 搜索
  - 空间索引
categories: 算法
mathjax: true
---

# 概述

中国的即时食品配送服务变得非常流行。美团每天有超过3000万个订单由用户下单。美食通常在平均30分钟内送达给用户。为了充分发挥骑手和餐厅的能力，提出了送餐范围作为即时食品配送区域的基础设施产品。在我们的平台上设计并构建了一个基于送餐范围的检索系统。为了为数百万家餐厅合作伙伴绘制合适的送餐范围，**我们提出了一个开创性的送餐范围生成框架。通过使用空间计算技术和数据挖掘技术，提出了一个单一送餐范围生成算法。此外，我们还利用机器学习模型和组合优化技术提出了范围评分算法和决策算法。**

具体而言，提出了一种新颖的送餐范围样本生成方法，并使**用与范围相关的特征来估计每个送餐范围在一段时间内的订单数量和平均送餐时间**。然后，我们将候选范围选择过程形式化为一个二进制整数规划问题。我们的系统中集成了分支限界算法和启发式搜索算法。在线实验的结果表明，我们的新算法生成的范围明显优于手动生成的范围。

# 说明
![image.png](https://pic.imgdb.cn/item/65b456fd871b83018afc70a8.jpg)

餐厅的送餐范围是由黑色实线边界组成的不规则多边形。只有位于该多边形内的用户可以在我们的平台上浏览餐厅的菜单并下订单，例如位置A/B/C。对于骑手来说，跨越河流或离餐厅太远的地方很难进行配送。因此，在绘制送餐范围时，位置D和E被排除在多边形之外。

具体而言，送餐范围生成过程应遵循以下三个原则：

1. 餐厅的送餐范围应覆盖高需求区域；
2. 如果餐厅的供应能力相对较低，送餐范围应比其他餐厅的范围小；
3. 送餐范围不应覆盖远离的地点。此外，我们应确保来自同一个城市街区的用户可以在我们的平台上浏览相同的餐厅。

因此，为送餐范围生成过程制定了以下规则：

1. 送餐范围的边界应沿着道路走向；
2. 送餐范围的边界不应穿过城市街区；
3. 送餐范围不应覆盖或穿越配送困难的地点，例如海洋、河流、山丘、铁路等。

送餐范围系统架构，包括两个部分:



![](https://pic.imgdb.cn/item/65b4a88d871b83018af97e04.jpg)

1. 送餐范围索引服务，用于更新/添加/删除餐厅的送餐范围，并为用户端应用和餐厅合作伙伴端应用提供检索API；
2. 送餐范围生成系统。

# 配送范围生成算法

## 框架

算法旨在为目标站点中的每个餐厅生成一个合理的送餐范围，这些餐厅的产品基本上由一个特定的骑手团队进行配送。在我们的系统中，一个站点中的餐厅数量在200到1,000之间。范围生成框架包括三个主要阶段：

1. 候选送餐范围生成
2. 候选送餐范围评分
3. 送餐范围的组合优化

在第一阶段，为目标站点中的每个餐厅生成几个候选送餐范围。为了生成一个合理而优雅的范围，提出了一种新颖的单一范围生成算法，

在第二阶段，利用机器学习模型对这些范围进行预测或评分。每个餐厅的候选送餐范围是具有不同形状和大小的空间多边形。提取了一系列能够捕捉这些范围的特征。

在最后一个阶段，组合优化过程从候选范围中为每个餐厅选择一个送餐范围。这一阶段的目标是区分站点中的餐厅。通常情况下，更好的做法是将较大的送餐范围分配给具有较高用户转化率、更高产品准备效率和更便利的附近交通条件的餐厅

## 单个餐厅配送范围生成

本算法将在给定目标半径和定位点作为输入的情况下生成单个递送范围。定位点和范围边界上的点之间的导航距离应该（近似）等于输入半径。当输入多个输入半径时，该算法可以生成不同大小和形状的范围。

配送范围由具有多个顶点的多边形表示，其中两个相邻顶点通过线段连接。单范围生成算法包括四个模块：**初始化、业务需求满足、压缩和覆盖高需求领域**。每个模块都将前一个模块处理的暂定范围作为输入。

### 初始化

以餐厅的定位点为中心，以输入的半径画出一个圆。圆由边界上以相等间隔固定数量的点表示。然而，从这些点到中心的导航距离可能远大于它们的直线距离。为了解决这个问题，算法在这些原始点和中心之间的线段上搜索新的点，其导航距离到中心大致等于我们的目标半径。我们采用二分搜索的方式。在每一步中，一个边界点会向中心移动，移动的长度为：

**max(min(导航距离-目标半径，直线距离)/2，最小步长)**

导航距离和直线距离分别是边界点与中心之间的导航距离和直线距离，目标半径是我们输入的目标半径，而最小步长作为一个超参数，用于限制搜索过程中的最小移动长度。

![](https://pic.imgdb.cn/item/65b4b62a871b83018a2be54c.jpg)

黄色点标记餐厅位置点，橙色点标记从初始圆采样的边界点。 在导航距离修改过程中，边界点会向中心移动，以满足导航距离要求。

### 配送范围形状优化

**配送范围边界应沿着道路进行规划**。如果配送范围的边界横跨建筑物或街区，可能会给同一建筑物内的用户带来不同的使用体验。具体而言，可能存在这样一种情况：建筑物内的一些用户可以在我们的平台上下订单，而其他一些用户则不行。为了沿着道路确定边界，我们的算法将导航路线替换为相邻边界点之间的直线段。在这个过程中会添加新的边界点。此外，每个站点都保留一个最大配送范围，标记着该站点的所有配送员可以到达的地方。生成的配送范围将与最大配送范围进行交集运算，以排除一些不适当的区域。



![](https://pic.imgdb.cn/item/65b4b953871b83018a374d2a.jpg)

**删除导航路线过程中在边界上的杂乱点**以获得优雅的配送范围。按顺序分配边界点的索引，并记录它们所属的GeoHashes。

> GeoHash是一个公共领域的地理编码系统，将地理位置编码成一个由字母和数字组成的短字符串。

然后，针对每个GeoHash，我们的算法找到最小索引点和最大索引点。如果大多数中间点位于远离当前GeoHash的GeoHashes中，算法将这两个点之间的路径视为杂乱部分，并通过直接连接这两个点来移除它。

### 范围压缩

在导航路线过程中引入了大量边界点，在范围压缩模块中，我们的算法通过**移除冗余点**来实现更高效的数据计算和存储。我们**计算每个点与其后续点和前一个点之间的角度。如果角度足够接近180度，那么该点将被移除**。

另一种策略是根据相邻点之间的角度和距离对每个点进行评估，得分较高的点将被保留。系统还在压缩模块中集成了***Douglas-Peucker*算法**。

>Douglas-Peucker算法
>
>S-T Wu and MERCEDES ROCio GONZALES Marquez. 2003. A non-self-intersection Douglas-Peucker algorithm. In 16th Brazilian symposium on computer graphics and Image Processing (SIBGRAPI 2003). IEEE, 60–66.

![](https://pic.imgdb.cn/item/65b4c07f871b83018a50500f.jpg)

### 覆盖高需求区域

**修改配送范围以覆盖更多的高需求区域。**在之前提到的初始化部分，算法以目标餐厅的位置点为中心绘制一个圆。**实际上，在我们的系统中，中心点是一个偏移点，它是基于位置点和附近区域订单的分布计算得出的。**除此之外，一些高需求区域直接合并到配送范围中。这些高需求区域是GeoHashes聚类的结果。在我们的系统中，K-means和*DBSCAN算法*都是合理的选择，并被采用。最后，这些潜在区域被合并形成一个新的多边形，即最终的配送范围，同时保持导航距离的限制。

> DBSCAN算法
>
> Martin Ester, Hans-Peter Kriegel, Jörg Sander, Xiaowei Xu, et al. 1996. A density-based algorithm for discovering clusters in large spatial databases with noise.. In Kdd, Vol. 96. 226–231.

![](https://pic.imgdb.cn/item/65b4c0ff871b83018a520898.jpg)



## 单个范围评分

在为单个餐厅生成具有不同半径的候选配送范围后，计算它们的得分。**分数包括一段时间内的订单数量和平均交付时间。**

如果待评分的目标范围在餐厅当前的配送范围内（黄色区域），直接统计订单数即可。

对于一个比当前餐厅范围范围更大的候选范围，评分过程将包含两个阶段：

1. 计算较大范围与当前餐厅配送范围的交集内的订单数量。交集部分对应于黄色区域。
2. 对于当前范围外的区域，如图中的粉色带，将使用**回归模型**。这两个部分将相加，得到订单数量的最终估计值。

![](https://pic.imgdb.cn/item/65b5ab83871b83018a42578f.jpg)

在预测部分，按照以下方式构建样本：**对于平台上的每个餐厅，我们将其当前的配送范围缩小为较小的范围，我们称之为"虚拟范围"。然后，我们可能将虚拟范围视为餐厅的实际范围，并将外部带中的用户下单数量视为标签。**通过这样做，我们可以从一个餐厅获得许多样本。在我们的特征中，一些是基于虚拟范围和外部带的空间信息提取的。我们比较了几种常见的回归模型，如岭回归、随机森林和XGBoost。

如下图，虚线表示的三个紫色范围是由同一个餐厅生成的虚拟范围。它们对应数据集中的三个样本。标签是外部粉色带区域内用户下单的数量。

![](https://pic.imgdb.cn/item/65b5ac6e871b83018a44a488.jpg)

平均交付时间的计算方法和订单数类似。

## 配送范围优化

需要利用所有这些信息来为每个餐厅分配一个合理的配送范围，以实现全局最优（或近似最优）的GMV（全球商品交易额）或者站点的订单数量，并同时保证用户的体验。

问题定义为：对于目标车站，有 $N$ 个餐厅，每个餐厅有 $M$ 个候选配送范围有不同的size。 $S_{n, m}$ 表示第 $n$ 个餐厅的第 $m$ 个候选。 $O_{n, m}$ 和 $T_{n, m}$ 表示预测的订单数和平均订单配送时间。 $P_n$ 表示根据历史数据计算出来的第 $n$ 个餐厅的平均产品价格。平均配送时间视为用户体验， $\bar{T}$表示目标的上界。使用01变量 $C_{n, m}$ 表示第 $m$ 个候选范围是否应该是第 $n$ 个餐厅的，问题就被转化为 01 整数规划问题。

![](https://pic.imgdb.cn/item/65b5b8b6871b83018a67d1b7.jpg)

BIP是NP-hard问题，有一些启发式算法如爬山算法、模拟退火算法可以得到近似解。本系统中，通常设计 $M$ 为 10 或小于 10 ，将车站中的餐厅数设置小于 $1 \mathrm{k}$ 。因此 $C_{n, m}$ 的总数在千级别。 branch 和 bound算法能够解决这个规模的BIP问题在秒级别。然后在系统中用启发式算法解决餐厅超过 $1 \mathrm{k}$ 的的问题，因为那样brand和bound算法会若干分钟。算法1展示了启发式搜索的细节。近似解也可以用来作为branch和bound算法的初始。

![](https://pic1.zhimg.com/v2-d675cc4c6402d3addcd88ff1a7119c10_r.jpg)

## 复杂度计算

改进的binary搜索处理所有点需要 $O(K)$ 。Navigation Route Process也需要在相邻点查询导航路线，耗费 $O(K)$ 。在Remove Stub和Compression也耗费 $O(K)$。所以生成单个配送范围耗费 $O(K)$ 复杂度。

那么为一个车站获得所有候选范围需要 $O(K N M)$ 。

在范围打分时，采用的是XGBoost算法。树深度、迭代次数、特征个数在训练前处理，需要耗费 $O(N M)$ 得到左右的范围的分数。

范围分配环节是求解一个BIP问题，Branch和bound算法能得到一个具体解，但复杂度相对较大，取决于数据量。采用的启发式算法能得到近似解，大概需要 $N M$ 步，因此复杂度为 $O(K N M)$

总之，整个配送范围生成算法为 $O(K N M)$ 。

# 实验

未完待续！
